{% extends 'base3.html.twig' %}

{% block body %}
<section>
    <div class="container" data-aos="fade-up" data-aos-delay="100">
        <h1 class="text-center mb-4">Détails de l'Hébergement : {{ hebergement.nom }}</h1>

        <div style="display: flex; justify-content: flex-start; align-items: flex-start; gap: 20px;">
            {% if hebergement.image %}
                <div class="text-center mb-4">
                    <img src="{{ asset('uploads/images/' ~ hebergement.image) }}" alt="{{ hebergement.nom }}" 
                         style="max-width: 300px; border-radius: 10px;">
                </div>
            {% endif %}

            <div>
                <p><strong>Titre Hébergement:</strong> {{ hebergement.nom }}</p>
                <p><strong>Type :</strong> {{ hebergement.type }}</p>
                <p><strong>Adresse :</strong> {{ hebergement.adresse }}</p>
                <p><strong>Capacité :</strong> {{ hebergement.capacite }}</p>
                <p><strong>Description :</strong> {{ hebergement.description }}</p>

                <div class="mt-3">
                   

                    <a href="{{ path('hebergement_edit', {'idhebergement': hebergement.idhebergement}) }}" 
                       class="btn btn-primary">
                        <i class="bi bi-pencil"></i> Modifier
                    </a>
                </div>
            </div>
        </div>

        <hr>

        <h3>Programmes associés :</h3>
        <ul class="list-group">
            {% if programmes is empty %}
                <li class="list-group-item">Aucun programme associé</li>
            {% else %}
                {% for programme in programmes %}
                    <li class="list-group-item">
                        <strong>Nom :</strong> {{ programme.nom }} <br>
                        <strong>Lieu :</strong> {{ programme.lieu }} <br>
                        <strong>Date début :</strong> {{ programme.dateDebut|date('d/m/Y H:i') }} <br>
                        <strong>Date fin :</strong> {{ programme.dateFin|date('d/m/Y H:i') }} <br>
                        <strong>Description :</strong> {{ programme.description }} <br>

                        <a href="{{ path('programme_edit', {'id': programme.id}) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Modifier
                        </a>
                        <form method="post" action="{{ path('programme_delete', {'id': programme.id}) }}" 
                              style="display:inline;" 
                              onsubmit="return confirm('Confirmer la suppression de ce programme ?');">
                            <input type="hidden" name="_token" value="{{ csrf_token('delete' ~ programme.id) }}">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-trash"></i> Supprimer
                            </button>
                        </form>
                    </li>
                {% endfor %}
            {% endif %}
        </ul>

        <a href="{{ path('programme_new', {'hebergementId': hebergement.idhebergement}) }}" 
           class="btn btn-primary mt-3">
            <i class="bi bi-plus-circle"></i> Ajouter un programme
        </a>
    </div>
</section>

<hr>

<h1 class="text-center mb-4">Réservations pour {{ hebergement.nom }}</h1>

{% if reservations is empty %}
    <p class="text-center">Aucune réservation pour cet hébergement.</p>
{% else %}
    <div class="container">
        <div class="table-responsive">
            <table class="table table-bordered table-hover text-center">
                <thead class="thead-dark">
                    <tr>
                        <th>Utilisateur</th>
                        <th>Statut</th>
                        <th>Numéro de téléphone</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for reservation in reservations %}
                        <tr>
                            <td>{{ reservation.user.username }}</td>
                            <td>
                                {% if reservation.statut == 'pending' %}
                                    <span class="badge badge-warning">En attente</span>
                                {% elseif reservation.statut == 'accepted' %}
                                    <span class="badge badge-success">Acceptée</span>
                                {% else %}
                                    <span class="badge badge-danger">Refusée</span>
                                {% endif %}
                            </td>
                            <td>{{ reservation.user.numeroTelephone }}</td>
                            <td>
                                {% if reservation.statut == 'pending' %}
                                    <form action="{{ path('reservation_traiter', {idReservation: reservation.id, action: 'accepter'}) }}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-success btn-sm">Accepter</button>
                                    </form>

                                    <form action="{{ path('reservation_traiter', {idReservation: reservation.id, action: 'refuser'}) }}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-danger btn-sm">Refuser</button>
                                    </form>
                                {% elseif reservation.statut == 'accepted' %}
                                    <span class="text-success">Réservation acceptée</span>
                                {% elseif reservation.statut == 'refused' %}
                                    <span class="text-danger">Réservation refusée</span>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endif %}
{% block javascripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const reservationForms = document.querySelectorAll('.reservation-form');

    reservationForms.forEach(form => {
        form.addEventListener('submit', function(event) {
            event.preventDefault();  // Prevent the form submission

            // Récupérer l'action et l'ID de la réservation à partir du bouton de soumission
            const action = this.querySelector('button').getAttribute('data-action');
            const reservationId = this.querySelector('button').getAttribute('data-id');

            fetch(`{{ path('reservation_traiter', {idReservation: 'XXX', action: 'YYY'}) }}`
                  .replace('XXX', reservationId)
                  .replace('YYY', action), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Mise à jour du statut dans le tableau
                    const statutCell = document.getElementById(`statut-${reservationId}`);
                    if (action === 'accepter') {
                        statutCell.innerHTML = '<span class="badge badge-success">Acceptée</span>';
                    } else if (action === 'refuser') {
                        statutCell.innerHTML = '<span class="badge badge-danger">Refusée</span>';
                    }

                    // Afficher un message de succès dans l'interface
                    alert(data.message);  // Ceci montre un message comme "Statut de la réservation mis à jour et email envoyé"
                } else {
                    alert('Une erreur est survenue.');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue.');
            });
        });
    });
});

</script>

{% endblock %}
{% endblock %}
